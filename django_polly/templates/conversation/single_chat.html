<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Chat UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.11"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/ws.js"></script>
</head>
<body class="bg-gray-200">
    <div class="flex h-screen">
        <div class="flex-1 flex flex-col bg-white overflow-hidden shadow-md"
             hx-ext="ws"
             ws-connect="/polly/ws/smart-gpt-admin/?user_id={{ request.user.id }}&conversation_id={{ conversation_id }}">
            <div id="message-list" class="p-6 flex-1 overflow-y-auto">
                <!-- Messages will be inserted here by the consumer -->
            </div>

            <form id="chat-form" class="border-t-2 border-gray-200 px-4 py-4 mb-2 sm:mb-0" ws-send>
                <div class="relative flex">
                    <input type="text"
                           id="message-input"
                           placeholder="Write something..."
                           name="message"
                           class="pl-4 pr-10 py-3 rounded-xl border-2 border-gray-200 w-full focus:outline-none focus:border-indigo-300">
                    <button id="send-button" type="submit"
                            class="ml-2 bg-blue-600 text-white rounded-xl px-4 py-2 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        Send
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const chatForm = document.getElementById('chat-form');
        const messageList = document.getElementById('message-list');

        function scrollToBottom() {
            messageList.scrollTop = messageList.scrollHeight;
        }

        // Scroll to bottom initially
        scrollToBottom();

        document.body.addEventListener('htmx:wsAfterSend', function(event) {
            console.log('Message sent, clearing input and disabling button');
            messageInput.value = '';
            sendButton.disabled = true;
            scrollToBottom();
        });

        document.body.addEventListener('htmx:wsAfterMessage', function(event) {
            console.log('Received message:', event.detail.message);
            try {
                const message = JSON.parse(event.detail.message);
                if (message.type === "assistant_message_complete") {
                    console.log('Assistant message complete, enabling button');
                    sendButton.disabled = false;
                }
            } catch (error) {
                console.error('Error parsing message:', error);
            }
            // Scroll to bottom after receiving any message
            scrollToBottom();
        });

        chatForm.addEventListener('submit', function(event) {
            if (messageInput.value.trim() === '') {
                event.preventDefault();
            }
        });

        // Additional event listener for any WebSocket message
        document.body.addEventListener('htmx:wsMessage', function(event) {
            console.log('WebSocket message received:', event.detail.message);
            // Scroll to bottom after any WebSocket message
            scrollToBottom();
        });

        // MutationObserver to watch for changes in the message list
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    scrollToBottom();
                }
            });
        });

        // Configure the observer to watch for child changes in the message list
        const config = { childList: true, subtree: true };
        observer.observe(messageList, config);
    </script>
</body>
</html>